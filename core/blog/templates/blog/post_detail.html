{% extends "base.html" %}
{% load static %}
{% load blog_extras %}

{% block title %}Post Detail{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static "blog/css/post_detail.css" %}">
{% endblock extra_css %}

{% block script %}
{% endblock script %}

{% block content %}
<div class="post_container" {% if post.category %}style="border-left: 5px solid {{ post.category.color }}"{% endif %}>
    <div class="post_header">
        <div class="post_header_section">
            <img class="image" src="{% if post.author.image %}{{ post.author.image.url }}{% else %}{% static "img/profile.png" %}{% endif %}" alt="{{ post.author.username }}" width="48" height="48">
            <div class="author_info">
                <h4>{{ post.author.username }}</h4>
                <h6>{{ post.author.email }}</h6>
            </div>
            <p class="category_badge" style="background-color: {{ post.category.color }};">{{ post.category.name }}</p>
            <div class="author_info">
                <small>Published: {{ post.created_at|date_format }}</small>
            </div>
        </div>
        {% if post.author == request.user %}
        <div class="post_header_section">
            <a href="{% url "post:update" pk=post.pk %}"><button class="action_button" style="background-image: url({% static "blog/img/edit.svg" %});" title="Edit"></button></a>
            <button class="action_button" style="background-image: url({% static "blog/img/delete.svg" %});" title="Delete" onclick="delete_post('{% url 'post:delete' pk=post.pk %}')"></button>
        </div>
        {% endif %}
    </div>
    <div class="post_content">
        <h3>{{ post.title }}</h3>
        <p>{{ post.content }}</p>
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}">
        {% endif %}
    </div>
    <form action="{% url "comment:create" post_pk=post.pk %}" method="post" class="post_footer">
        {% csrf_token %}
        <img src="{% if request.user.image %}{{ request.user.image.url }}{% else %}{% static "img/profile.png" %}{% endif %}" alt="" class="small_image" width="24" height="24">
        <textarea name="content" id="content" rows="1" placeholder="Comment..."></textarea>
        <input type="submit" style="background-image: url('{% static 'blog/img/send.svg' %}');" value="" title="Send">
        <p>{{ post.comments.all|length }} comment{{ post.comments.all|length|pluralize }}</p>
    </form>
</div>

{% if post.comments.all|length > 0 %}
<div class="post_container" id="comments">
    <h4 class="post_header">Comments</h4>
    {% for comment in post.comments.all %}
    <div class="comment_container">
        <div class="comment_header">
            <img class="image" src="{% if comment.author.image %}{{ comment.author.image.url }}{% else %}{% static "img/profile.png" %}{% endif %}" alt="{{ post.author.username }}" width="36" height="36">
            <div class="author_info" style="flex-grow: 1;">
                <h5>{{ comment.author.username }}</h5>
                <h6>{{ comment.author.email }}</h6>
            </div>
            {% if comment.author == request.user %}
            <div class="comment_actions">
                <button class="action_button" style="background-image: url({% static "blog/img/edit.svg" %});" title="Edit" onclick="update_comment('{% url 'comment:update' pk=comment.pk %}', '{{ comment.content }}')"></button>
                <button class="action_button" style="background-image: url({% static "blog/img/delete.svg" %});" title="Delete" onclick="delete_comment('{% url 'comment:delete' pk=comment.pk %}')"></button>
            </div>
            {% endif %}
            <div class="author_info">
                <small>{{ comment.published_at|date_format }}</small>
            </div>
        </div>
        <div class="comment_content">
            <small>{{ comment.content }}</small>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<form method="post" id="delete_form" class="modal hidden">
    {% csrf_token %}
    <p>Are you sure you want to delete this post?</p>
    <div class="form_section_h">
        <input type="submit" value="Delete" class="btn" style="background-color: red;">
        <button type="button" onclick="close_delete_modal()" class="btn">Cancel</button>
    </div>
</form>

<form method="post" id="update_comment" class="modal hidden">
    {% csrf_token %}
    <div class="form_section">
        <label for="update_content">Content</label>
        <textarea name="content" id="update_content" rows="2">{{ comment.content }}</textarea>
    </div>
    <div class="form_section_h">
        <input type="submit" value="Update" class="btn">
        <button type="button" onclick="close_update_modal()" class="btn">Cancel</button>
    </div>
</form>

<form method="post" id="delete_comment" class="modal hidden">
    {% csrf_token %}
    <p>Are you sure you want to delete this comment?</p>
    <div class="form_section_h">
        <input type="submit" value="Delete" class="btn" style="background-color: red;">
        <button type="button" onclick="close_delete_comment_modal()" class="btn">Cancel</button>
    </div>
</form>
{% endblock content %}

{% block extra_js %}
<script src="{% static "blog/js/post_detail.js" %}"></script>
{% endblock extra_js %}